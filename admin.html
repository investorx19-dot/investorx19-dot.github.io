<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Admin • Mark6</title>

  <style>
    :root{
      --bg1:#061024; --bg2:#030712;
      --card:rgba(255,255,255,.07);
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff; --muted:rgba(234,240,255,.75);
      --blue:#2d6cff; --green:#22c55e; --red:#ef4444;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(45,108,255,.25), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(245,158,11,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:26px 18px 60px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{
      width:44px;height:44px;border-radius:12px;object-fit:cover;
      border:1px solid rgba(255,255,255,.12);
      background:#0f172a;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:13px;
    }
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;border-radius:12px;
      cursor:pointer;transition:.15s;
      font-weight:700;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn.primary{background:var(--blue);border-color:rgba(255,255,255,.14)}
    .btn.danger{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.35)}
    .btn.success{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.35)}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width: 980px){ .grid{grid-template-columns: 1fr 1.2fr} }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px;font-size:16px}
    .sep{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
    label{font-size:13px;color:var(--muted)}
    input{
      width:100%;padding:11px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(234,240,255,.45)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 700px){ .two{grid-template-columns:1fr} }

    .nums{display:grid;gap:10px}
    .nums6{grid-template-columns: repeat(6, 1fr)}
    .nums5{grid-template-columns: repeat(5, 1fr)}
    @media (max-width:700px){
      .nums6{grid-template-columns: repeat(3, 1fr)}
      .nums5{grid-template-columns: repeat(3, 1fr)}
    }

    .checkboxes{display:grid;gap:10px}
    .checkboxes label{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      cursor:pointer;
    }
    .checkboxes input{width:auto}

    .toast{
      display:none;
      margin: 0 0 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .toast.show{display:block}
    .toast.error{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color: rgba(255,255,255,.92)}
    .toast.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: rgba(255,255,255,.92)}

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size: 13px;
      vertical-align:middle;
    }
    th{color: rgba(234,240,255,.90); font-weight:800; background: rgba(255,255,255,.04)}
    td{color: rgba(234,240,255,.86)}
    .right{text-align:right}
    .status{font-weight:900;display:inline-flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.green{background:var(--green)}
    .dot.red{background:var(--red)}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .loginBox{max-width:560px;margin: 18px auto 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <!-- Ajuste o nome do arquivo se precisar -->
        <img class="logo" src="logo-marck6.jpg" alt="Mark6" onerror="this.style.display='none'">
        <div>
          <h1>Painel de Controle • Administrador</h1>
          <div class="sub">Mark6 • Firebase Auth + Firestore</div>
        </div>
      </div>

      <div class="row">
        <span id="who" class="pill">Não autenticado</span>
        <button id="btnReload" class="btn">Recarregar</button>
        <button id="btnLogout" class="btn danger" style="display:none">Sair</button>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- LOGIN -->
    <div id="loginCard" class="card loginBox">
      <h2>Login do Admin</h2>
      <div class="small">Acesso permitido apenas para <b class="mono">decarvalho01@gmail.com</b>.</div>
      <div class="sep"></div>

      <div class="two">
        <div>
          <label for="adminEmail">E-mail</label>
          <input id="adminEmail" type="email" placeholder="decarvalho01@gmail.com" autocomplete="username">
        </div>
        <div>
          <label for="adminPass">Senha</label>
          <input id="adminPass" type="password" placeholder="Sua senha" autocomplete="current-password">
        </div>
      </div>

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="btnLogin" class="btn primary">Entrar</button>
      </div>

      <div class="sep"></div>
      <div class="small">
        Se aparecer “Missing or insufficient permissions”, é Rules do Firestore ou login fora do e-mail admin.
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none">
      <div class="grid">
        <!-- CONFIG -->
        <div class="card">
          <h2>Configuração Global</h2>

          <div class="sep"></div>

          <h2>1) Linhas Ativas</h2>
          <div class="checkboxes" id="linesBox"></div>

          <div class="sep"></div>

          <h2>2) Dezenas do Sorteio Anterior</h2>
          <div class="nums nums6" id="prevBox"></div>

          <div class="sep"></div>

          <h2>3) 5 Dezenas Mais Atrasadas</h2>
          <div class="nums nums5" id="lateBox"></div>

          <div class="sep"></div>

          <div class="row" style="justify-content:flex-end">
            <button id="btnLoadConfig" class="btn">Recarregar config</button>
            <button id="btnSaveConfig" class="btn primary">Salvar config</button>
          </div>

          <div class="small" style="margin-top:10px">
            Salvo em <span class="mono">config/global</span>.
          </div>
        </div>

        <!-- USERS -->
        <div class="card">
          <h2>Controle de Acesso dos Usuários</h2>

          <div class="row" style="justify-content:space-between; margin-bottom:10px">
            <div class="small" id="dupInfo">—</div>
            <button id="btnReloadUsers" class="btn">Atualizar lista</button>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>E-mail</th>
                  <th>Telefone</th>
                  <th class="right">Acesso</th>
                  <th class="right">Ação</th>
                </tr>
              </thead>
              <tbody id="usersTbody">
                <tr><td colspan="5" class="small">Carregando...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="sep"></div>
          <div class="small">
            Duplicação visual: se existirem docs repetidos por e-mail, mostramos o mais recente (não apaga do banco).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ ÚNICO script: module (evita initializeApp undefined) -->
  <script type="module">
    // ===============================
    // FIREBASE
    // ===============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const ADMIN_EMAIL = "decarvalho01@gmail.com";

    const firebaseConfig = {
      apiKey: "AIzaSyA9ccyTSDoWiqrwnq9K7nAEjeOHZahKIu0",
      authDomain: "painel-megasena.firebaseapp.com",
      projectId: "painel-megasena",
      storageBucket: "painel-megasena.firebasestorage.app",
      messagingSenderId: "924943702876",
      appId: "1:924943702876:web:77929086c5addb13b37f99"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // ===============================
    // UI helpers
    // ===============================
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");

    function toast(msg, type="ok"){
      toastEl.className = "toast show " + (type === "error" ? "error" : "ok");
      toastEl.textContent = msg;
      setTimeout(() => { toastEl.className = "toast"; }, 3800);
    }

    function normEmail(s){ return String(s || "").trim().toLowerCase(); }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function createLineCheckboxes(){
      const linesBox = $("linesBox");
      const ranges = {
        1:"01–10", 2:"11–20", 3:"21–30", 4:"31–40", 5:"41–50", 6:"51–60"
      };
      linesBox.innerHTML = "";
      for(let i=1;i<=6;i++){
        const lab = document.createElement("label");
        lab.innerHTML = `
          <input type="checkbox" class="linha" value="${i}">
          <span><b>Linha ${i}</b> (${ranges[i]})</span>
        `;
        linesBox.appendChild(lab);
      }
    }

    function createNumberInputs(containerId, cssClass, count){
      const box = $(containerId);
      box.innerHTML = "";
      for(let i=0;i<count;i++){
        const input = document.createElement("input");
        input.type = "number";
        input.min = "1";
        input.max = "60";
        input.placeholder = "00";
        input.className = cssClass; // "anterior" ou "atrasada"
        input.inputMode = "numeric";
        box.appendChild(input);
      }
    }

    function readNums(cssSelector){
      return [...document.querySelectorAll(cssSelector)]
        .map(i => Number(i.value))
        .filter(n => Number.isFinite(n) && n >= 1 && n <= 60);
    }

    function fillNums(cssSelector, arr){
      const inputs = [...document.querySelectorAll(cssSelector)];
      for(let i=0;i<inputs.length;i++){
        inputs[i].value = (arr && arr[i] != null) ? arr[i] : "";
      }
    }

    // Build UI once
    createLineCheckboxes();
    createNumberInputs("prevBox", "anterior", 6);
    createNumberInputs("lateBox", "atrasada", 5);

    // ===============================
    // Auth UI
    // ===============================
    $("btnReload").addEventListener("click", () => location.reload());

    $("btnLogin").addEventListener("click", async () => {
      const email = $("adminEmail").value.trim();
      const pass  = $("adminPass").value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        console.error(err);
        toast("Falha no login (email/senha).", "error");
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
      toast("Você saiu.", "ok");
    });

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        $("who").textContent = "Não autenticado";
        $("btnLogout").style.display = "none";
        $("loginCard").style.display = "block";
        $("app").style.display = "none";
        return;
      }

      const email = normEmail(user.email);
      $("who").textContent = `Logado: ${email}`;
      $("btnLogout").style.display = "inline-block";

      // bloqueia se não for admin
      if(email !== normEmail(ADMIN_EMAIL)){
        toast("Este usuário não é admin. Saindo...", "error");
        await signOut(auth);
        return;
      }

      // admin ok
      $("loginCard").style.display = "none";
      $("app").style.display = "block";

      await loadConfig();
      await loadUsers();
    });

    // ===============================
    // Config: config/global
    // ===============================
    async function loadConfig(){
      try{
        const ref = doc(db, "config", "global");
        const snap = await getDoc(ref);

        let linhasAtivas = [];
        let dezenasAnteriores = [];
        let dezenasAtrasadas = [];

        if(snap.exists()){
          const data = snap.data();
          linhasAtivas = data.linhasAtivas || [];
          dezenasAnteriores = data.dezenasAnteriores || [];
          dezenasAtrasadas = data.dezenasAtrasadas || [];
        }

        document.querySelectorAll(".linha").forEach(cb => {
          cb.checked = linhasAtivas.includes(Number(cb.value));
        });

        fillNums(".anterior", dezenasAnteriores);
        fillNums(".atrasada", dezenasAtrasadas);

        toast("Config carregada.", "ok");
      }catch(err){
        console.error(err);
        toast("Erro ao carregar config (Rules?).", "error");
      }
    }

    async function saveConfig(){
      try{
        const linhasAtivas = [...document.querySelectorAll(".linha:checked")].map(el => Number(el.value));
        const anterior = readNums(".anterior");
        const atrasadas = readNums(".atrasada");

        await setDoc(doc(db, "config", "global"), {
          linhasAtivas,
          dezenasAnteriores: anterior,
          dezenasAtrasadas: atrasadas,
          updatedAt: Date.now()
        }, { merge: true });

        toast("Config salva com sucesso.", "ok");
      }catch(err){
        console.error(err);
        toast("Erro ao salvar config (Missing permissions).", "error");
      }
    }

    $("btnLoadConfig").addEventListener("click", loadConfig);
    $("btnSaveConfig").addEventListener("click", saveConfig);

    // ===============================
    // Users list
    // ===============================
    async function loadUsers(){
      const tbody = $("usersTbody");
      tbody.innerHTML = `<tr><td colspan="5" class="small">Carregando...</td></tr>`;

      try{
        const snap = await getDocs(collection(db, "users"));
        const docs = [];
        snap.forEach(d => docs.push({ id: d.id, ...d.data() }));

        // de-dupe por email (mostra o mais recente)
        const map = new Map();
        let hidden = 0;

        for(const u of docs){
          const email = normEmail(u.email);
          if(!email) continue;

          const ts = Number(u.updatedAt || u.createdAt || 0);
          if(!map.has(email)){
            map.set(email, u);
          }else{
            const cur = map.get(email);
            const curTs = Number(cur.updatedAt || cur.createdAt || 0);
            if(ts >= curTs) map.set(email, u);
            hidden++;
          }
        }

        const users = [...map.values()]
          .sort((a,b) => normEmail(a.email).localeCompare(normEmail(b.email)));

        $("dupInfo").textContent = hidden > 0
          ? `⚠️ ${hidden} duplicado(s) ocultado(s) por e-mail (mostrando apenas o mais recente).`
          : `Sem duplicações detectadas.`;

        if(users.length === 0){
          tbody.innerHTML = `<tr><td colspan="5" class="small">Nenhum usuário encontrado.</td></tr>`;
          return;
        }

        tbody.innerHTML = "";
        for(const u of users){
          const granted = !!u.accessGranted;
          const phone = (u.telefone || u.phone || "").toString();

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(u.nome || u.name || "(sem nome)")}</td>
            <td class="mono">${escapeHtml(u.email || "")}</td>
            <td class="mono">${escapeHtml(phone || "-")}</td>
            <td class="right">
              <span class="status">
                <span class="dot ${granted ? "green" : "red"}"></span>
                ${granted ? "Liberado" : "Bloqueado"}
              </span>
            </td>
            <td class="right">
              <button class="btn ${granted ? "danger" : "success"}"
                data-userid="${escapeHtml(u.id)}"
                data-granted="${granted}">
                ${granted ? "Bloquear" : "Liberar"}
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll("button[data-userid]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const userId = btn.getAttribute("data-userid");
            const granted = btn.getAttribute("data-granted") === "true";
            await toggleAccess(userId, !granted);
          });
        });

      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="5" class="small">Erro ao carregar usuários.</td></tr>`;
        toast("Erro ao carregar usuários (Rules?).", "error");
      }
    }

    async function toggleAccess(userDocId, newValue){
      try{
        await updateDoc(doc(db, "users", userDocId), {
          accessGranted: newValue,
          updatedAt: Date.now()
        });
        toast(newValue ? "Usuário liberado." : "Usuário bloqueado.", "ok");
        await loadUsers();
      }catch(err){
        console.error(err);
        toast("Falha ao alterar acesso (Rules?).", "error");
      }
    }

    $("btnReloadUsers").addEventListener("click", loadUsers);
  </script>
</body>
</html>
