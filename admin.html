<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Admin - Gerador de Jogos</title>
  <style>
    body {font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7;}
    h2 {margin-top: 25px; color: #333;}
    input, button {margin: 5px; padding: 8px;}
    button {background: #0066cc; color: white; border: none; cursor: pointer;}
    table {width: 100%; border-collapse: collapse; margin-top: 15px;}
    td, th {border: 1px solid #ccc; padding: 10px; text-align: center;}
    .numero {font-weight: bold; font-size: 1.1em;}
  </style>
</head>
<body>

  <h1>Painel de Controle - Administrador</h1>

  <h2>1. Linhas Ativas (selecione as linhas do volante)</h2>
  <div>
    <label><input type="checkbox" class="linha" value="1"> Linha 1 (01-10)</label><br>
    <label><input type="checkbox" class="linha" value="2"> Linha 2 (11-20)</label><br>
    <label><input type="checkbox" class="linha" value="3"> Linha 3 (21-30)</label><br>
    <label><input type="checkbox" class="linha" value="4"> Linha 4 (31-40)</label><br>
    <label><input type="checkbox" class="linha" value="5"> Linha 5 (41-50)</label><br>
    <label><input type="checkbox" class="linha" value="6"> Linha 6 (51-60)</label>
  </div>

  <h2>2. Dezenas do Sorteio Anterior (6 números)</h2>
  <input type="number" class="anterior" min="1" max="60" placeholder="01">
  <input type="number" class="anterior" min="1" max="60" placeholder="02">
  <input type="number" class="anterior" min="1" max="60" placeholder="03">
  <input type="number" class="anterior" min="1" max="60" placeholder="04">
  <input type="number" class="anterior" min="1" max="60" placeholder="05">
  <input type="number" class="anterior" min="1" max="60" placeholder="06">

  <h2>3. 5 Dezenas Mais Atrasadas</h2>
  <input type="number" class="atrasada" min="1" max="60" placeholder="01">
  <input type="number" class="atrasada" min="1" max="60" placeholder="02">
  <input type="number" class="atrasada" min="1" max="60" placeholder="03">
  <input type="number" class="atrasada" min="1" max="60" placeholder="04">
  <input type="number" class="atrasada" min="1" max="60" placeholder="05">

  <br><br>
  <button id="btnGerar">GERAR JOGO</button>

  <h2>Jogos Gerados</h2>
  <table id="tabelaJogos">
    <thead><tr><th>Jogo</th><th>Acertos</th><th>Data</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Controle de Acesso dos Usuários</h2>
  <table id="tabelaUsuarios">
    <thead><tr><th>Nome</th><th>E-mail</th><th>Acesso</th><th>Ação</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- 1) Proteção simples do Admin (não é segura para produção, mas funciona) -->
  <script>
    if (sessionStorage.getItem("admin_ok") !== "1") {
      const senha = (prompt("Digite a senha do administrador:") || "").trim();
      if (senha !== "Eu63b@56") {
        alert("Acesso negado!");
        window.location.href = "index.html";
      } else {
        sessionStorage.setItem("admin_ok", "1");
      }
    }
  </script>

  <!-- 2) Seu gerador (mantém suas constantes/funções globais) -->
  <script src="gerador.js"></script>

  <!-- 3) Admin + Firebase/Firestore (módulo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore,
      doc, setDoc, getDoc,
      collection, getDocs,
      updateDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA9ccyTSDoWiqrwnq9K7nAEjeOHZahKIu0",
      authDomain: "painel-megasena.firebaseapp.com",
      projectId: "painel-megasena",
      storageBucket: "painel-megasena.firebasestorage.app",
      messagingSenderId: "924943702876",
      appId: "1:924943702876:web:77929086c5addb13b37f99"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- Helpers DOM ----------
    function getLinhas() {
      return [...document.querySelectorAll(".linha:checked")].map(el => +el.value);
    }
    function getAnterior() {
      return [...document.querySelectorAll(".anterior")]
        .map(el => +el.value)
        .filter(n => n >= 1 && n <= 60);
    }
    function getAtrasadas() {
      return [...document.querySelectorAll(".atrasada")]
        .map(el => +el.value)
        .filter(n => n >= 1 && n <= 60);
    }

    function renderJogosLocal() {
      const tbody = document.querySelector("#tabelaJogos tbody");
      tbody.innerHTML = "";
      const jogos = JSON.parse(localStorage.getItem("jogos") || "[]");
      jogos.forEach(j => {
        tbody.innerHTML += `<tr>
          <td>${j.numeros.map(n => String(n).padStart(2, "0")).join(", ")}</td>
          <td><strong>${j.acertos}</strong></td>
          <td>${j.data}</td>
        </tr>`;
      });
    }

    // ---------- Firestore: CONFIG ----------
    // config/global -> { linhasAtivas, dezenasAnteriores, dezenasAtrasadas, updatedAt }
    const configRef = doc(db, "config", "global");

    async function salvarConfigNoFirestore(linhasAtivas, anterior, atrasadas) {
      await setDoc(configRef, {
        linhasAtivas,
        dezenasAnteriores: anterior,
        dezenasAtrasadas: atrasadas,
        updatedAt: Date.now()
      }, { merge: true });
    }

    async function carregarConfigParaTela() {
      const snap = await getDoc(configRef);
      if (!snap.exists()) return;
      const data = snap.data();

      // marca checkboxes
      const linhas = new Set(data.linhasAtivas || []);
      document.querySelectorAll(".linha").forEach(cb => {
        cb.checked = linhas.has(+cb.value);
      });

      // preenche inputs (se houver)
      const ant = (data.dezenasAnteriores || []);
      const atr = (data.dezenasAtrasadas || []);
      document.querySelectorAll(".anterior").forEach((inp, i) => inp.value = ant[i] ?? "");
      document.querySelectorAll(".atrasada").forEach((inp, i) => inp.value = atr[i] ?? "");
    }

    // ---------- Firestore: USERS ----------
    // users/{email} -> { nome, email, senha, accessGranted, createdAt }
    const usersCol = collection(db, "users");

    async function renderUsuarios() {
      const tbody = document.querySelector("#tabelaUsuarios tbody");
      tbody.innerHTML = "";

      const snap = await getDocs(usersCol);
      const rows = [];
      snap.forEach(docSnap => rows.push({ id: docSnap.id, ...docSnap.data() }));

      // ordena por e-mail
      rows.sort((a,b) => String(a.email||a.id).localeCompare(String(b.email||b.id)));

      rows.forEach(u => {
        const email = u.email || u.id;
        const nome  = u.nome || "(sem nome)";
        const ok    = !!u.accessGranted;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${nome}</td>
          <td>${email}</td>
          <td>${ok ? "✅ Liberado" : "⛔ Bloqueado"}</td>
          <td><button data-email="${email}">${ok ? "Bloquear" : "Liberar"}</button></td>
        `;
        tbody.appendChild(tr);
      });

      // liga botões
      tbody.querySelectorAll("button[data-email]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const email = btn.getAttribute("data-email");
          const userRef = doc(db, "users", email);
          const snapUser = await getDoc(userRef);
          if (!snapUser.exists()) return alert("Usuário não encontrado no Firestore.");

          const atual = !!snapUser.data().accessGranted;
          await updateDoc(userRef, { accessGranted: !atual });

          // renderiza de novo (ou deixe o onSnapshot atualizar)
          await renderUsuarios();
        });
      });
    }

    // ---------- GERAÇÃO DO JOGO ----------
    async function gerarJogoAdmin() {
      const linhasAtivas = getLinhas();
      if (linhasAtivas.length === 0) {
        alert("Selecione pelo menos uma linha!");
        return;
      }

      const anterior = getAnterior();
      const atrasadas = getAtrasadas();

      // 1) Salva config no Firestore (isso é o que faz funcionar em qualquer dispositivo)
      await salvarConfigNoFirestore(linhasAtivas, anterior, atrasadas);

      // 2) Continua seu fluxo normal (gerar jogo local no admin, se quiser)
      const excluidas = new Set([...anterior, ...atrasadas]);
      const jogo = gerarJogoValido(linhasAtivas, excluidas);

      jogo.sort((a, b) => a - b);
      const jogoFormatado = jogo.map(n => String(n).padStart(2, "0"));
      const acertos = jogo.filter(n => anterior.includes(n)).length;

      // mantém histórico local do admin (opcional)
      const jogos = JSON.parse(localStorage.getItem("jogos") || "[]");
      jogos.push({ numeros: jogo, acertos, data: new Date().toLocaleString() });
      localStorage.setItem("jogos", JSON.stringify(jogos));
      renderJogosLocal();

      alert(`Jogo gerado: ${jogoFormatado.join(" - ")} | Acertos: ${acertos}`);
    }

    // ---------- INIT ----------
    document.getElementById("btnGerar").addEventListener("click", () => {
      gerarJogoAdmin().catch(err => alert("Erro no admin: " + err.message));
    });

    // Carrega config inicial na tela (para o admin ver o último estado)
    await carregarConfigParaTela();

    // Lista usuários e atualiza em tempo real
    await renderUsuarios();
    onSnapshot(usersCol, async () => {
      await renderUsuarios();
    });

    // Opcional: também ouvir mudanças na config
    onSnapshot(configRef, async () => {
      // se quiser que o admin veja atualizações externas, descomente:
      // await carregarConfigParaTela();
    });

    // histórico local do admin (se existir)
    renderJogosLocal();
  </script>

</body>
</html>
