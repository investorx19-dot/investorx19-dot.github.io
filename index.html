<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Jogos - Usuário</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {font-family: Arial, sans-serif; margin: 20px;}
    .linha {margin: 15px 0; padding: 10px; background: #fff; border: 1px solid #ccc;}
    .numero {display: inline-block; width: 38px; height: 38px; line-height: 38px; text-align: center; margin: 2px; font-weight: bold; border-radius: 6px;}
    .selecionado {background: yellow; color: black;}
    button {padding: 12px 20px; font-size: 16px; margin: 5px; cursor: pointer;}
    #login, #app {max-width: 600px; margin: 0 auto;}
    input {width: 100%; padding: 10px; font-size: 16px; margin: 6px 0; box-sizing: border-box;}
    .card {border:1px solid #ddd; padding:12px; border-radius:10px; background:#fafafa;}
    .row {display:flex; gap:10px; flex-wrap:wrap;}
    .row button {flex: 1;}
    small {opacity:.7;}
  </style>
</head>
<body>
  <h1>Gerador de Jogos - Mega-Sena</h1>

  <div id="login" class="card">
    <h2>Cadastro / Login</h2>
    <input id="nome" placeholder="Nome" />
    <input id="email" placeholder="E-mail" />
    <input id="senha" type="password" placeholder="Senha" />

    <div class="row">
      <button id="btnCadastrar">Cadastrar</button>
      <button id="btnEntrar">Entrar</button>
    </div>

    <small>Após cadastrar, aguarde o administrador liberar seu acesso.</small>
  </div>

  <div id="app" class="card" style="display:none;">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div>
        <strong id="bemvindo"></strong><br />
        <small id="emailLogado"></small>
      </div>
      <button id="btnSair">Sair</button>
    </div>

    <hr />

    <button id="btnGerar">GERAR JOGO</button>

    <h2>Cartão Virtual</h2>
    <div id="cartao"></div>

    <p><strong>Acertos no último sorteio:</strong> <span id="acertos">0</span></p>

    <hr />

    <h3>Assinatura para liberar o gerador</h3>
    <button onclick="window.open('https://invoice.infinitepay.io/plans/silvia-regina-967/ito0zFDGX', '_blank')">
      Assinatura Mensal - R$ 29,90
    </button>
    <button onclick="window.open('https://invoice.infinitepay.io/plans/silvia-regina-967/1Cpgone7Tx', '_blank')">
      Assinatura Anual - R$ 238,80
    </button>
  </div>

  <script src="gerador.js"></script>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // ======= CONFIG DO SEU FIREBASE (do seu print) =======
    const firebaseConfig = {
      apiKey: "AIzaSyA9ccyTSDoWiqrwnq9K7nAEjeOHZahKIu0",
      authDomain: "painel-megasena.firebaseapp.com",
      projectId: "painel-megasena",
      storageBucket: "painel-megasena.firebasestorage.app",
      messagingSenderId: "924943702876",
      appId: "1:924943702876:web:77929086c5addb13b37f99"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ======= Helpers =======
    const $ = (id) => document.getElementById(id);

    function normEmail(email) {
      return (email || "").trim().toLowerCase();
    }

    // usamos e-mail como ID do doc, mas codificado para evitar caracteres problemáticos
    function userDocId(email) {
      return encodeURIComponent(normEmail(email));
    }

    function showLogin() {
      $("login").style.display = "block";
      $("app").style.display = "none";
      $("nome").value = "";
      $("email").value = "";
      $("senha").value = "";
      sessionStorage.removeItem("user_email");
    }

    function showApp(user) {
      $("login").style.display = "none";
      $("app").style.display = "block";
      $("bemvindo").textContent = `Olá, ${user.nome || "Usuário"}!`;
      $("emailLogado").textContent = user.email || "";
      renderCartao([]);
      $("acertos").textContent = "0";
      sessionStorage.setItem("user_email", user.email);
    }

    // ======= Cadastro (sem duplicação) =======
    async function cadastrar() {
      const nome  = ($("nome").value || "").trim();
      const email = normEmail($("email").value);
      const senha = $("senha").value || "";

      if (!nome || !email || !senha) {
        alert("Preencha todos os campos");
        return;
      }

      const id = userDocId(email);
      const ref = doc(db, "users", id);
      const snap = await getDoc(ref);

      // ✅ Não permite duplicar
      if (snap.exists()) {
        alert("Esse e-mail já está cadastrado. Clique em Entrar.");
        return;
      }

      await setDoc(ref, {
        nome,
        email,
        senha,
        accessGranted: false,
        createdAt: Date.now()
      });

      alert("Cadastrado com sucesso! Aguarde liberação do administrador.");
    }

    // ======= Login (Firestore) =======
    async function login() {
      const email = normEmail($("email").value);
      const senha = $("senha").value || "";

      if (!email || !senha) {
        alert("Informe e-mail e senha");
        return;
      }

      const id = userDocId(email);
      const ref = doc(db, "users", id);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        alert("Credenciais inválidas");
        return;
      }

      const user = snap.data();

      if ((user.senha || "") !== senha) {
        alert("Credenciais inválidas");
        return;
      }

      if (!user.accessGranted) {
        alert("Seu acesso ainda não foi liberado pelo administrador");
        return;
      }

      showApp(user);
    }

    // ======= Gerar jogo (lê config do Firestore) =======
    async function gerarJogoUsuario() {
      try {
        // busca config do admin: config/global
        const cfgRef = doc(db, "config", "global");
        const cfgSnap = await getDoc(cfgRef);

        if (!cfgSnap.exists()) {
          alert("O administrador ainda não configurou o sistema (config/global não encontrado).");
          return;
        }

        const cfg = cfgSnap.data();
        const linhasAtivas = Array.isArray(cfg.linhasAtivas) ? cfg.linhasAtivas : [];
        const anteriores  = Array.isArray(cfg.dezenasAnteriores) ? cfg.dezenasAnteriores : [];
        const atrasadas   = Array.isArray(cfg.dezenasAtrasadas) ? cfg.dezenasAtrasadas : [];

        if (linhasAtivas.length === 0) {
          alert("O administrador ainda não configurou as linhas ativas.");
          return;
        }

        const excluidas = new Set([ ...anteriores, ...atrasadas ]);
        const jogo = gerarJogoValido(linhasAtivas, excluidas);

        renderCartao(jogo);

        const acertos = jogo.filter(n => anteriores.includes(n)).length;
        $("acertos").textContent = String(acertos);

      } catch (err) {
        alert("Erro ao gerar jogo: " + (err?.message || err));
      }
    }

    // ======= Cartão =======
    function renderCartao(jogo) {
      const cartao = $("cartao");
      cartao.innerHTML = "";

      for (let l = 1; l <= 6; l++) {
        const div = document.createElement("div");
        div.className = "linha";
        div.innerHTML = `<strong>Linha ${l} (${LINE_RANGES[l][0]}-${LINE_RANGES[l][9]}):</strong> `;

        LINE_RANGES[l].forEach(n => {
          const span = document.createElement("span");
          span.className = "numero";
          span.textContent = String(n).padStart(2, "0");
          if (jogo.includes(n)) span.classList.add("selecionado");
          div.appendChild(span);
        });

        cartao.appendChild(div);
      }
    }

    // ======= Sessão (manter logado) =======
    async function tentarAutoLogin() {
      const email = sessionStorage.getItem("user_email");
      if (!email) return;

      const id = userDocId(email);
      const ref = doc(db, "users", id);
      const snap = await getDoc(ref);

      if (!snap.exists()) return showLogin();

      const user = snap.data();
      if (!user.accessGranted) return showLogin();

      showApp(user);
    }

    // ======= Eventos UI =======
    $("btnCadastrar").addEventListener("click", cadastrar);
    $("btnEntrar").addEventListener("click", login);
    $("btnGerar").addEventListener("click", gerarJogoUsuario);
    $("btnSair").addEventListener("click", showLogin);

    // inicia
    tentarAutoLogin();
  </script>
</body>
</html>
