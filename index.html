<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Jogos - Usuário</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    body {font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7;}
    .linha {margin: 15px 0; padding: 10px; background: #fff; border: 1px solid #ccc;}
    .numero {display: inline-block; width: 38px; height: 38px; line-height: 38px; text-align: center; margin: 2px; font-weight: bold; border-radius: 6px;}
    .selecionado {background: yellow; color: black;}
    button {padding: 12px 20px; font-size: 16px; margin: 5px; cursor: pointer;}
    input {padding: 10px; width: 100%; box-sizing: border-box; font-size: 14px;}
    #login, #app {max-width: 600px; margin: 0 auto;}
    .card {background:#fff; border:1px solid #ddd; padding:16px; border-radius:10px;}
    .topo {display:flex; align-items:center; gap:12px; justify-content:center; margin: 10px 0 20px;}
    .logo {width: 140px; height:auto; display:block;}
    h1 {text-align:center; margin:0 0 10px;}
    .sub {text-align:center; color:#444; margin: 0 0 18px;}
    .row {display:flex; gap:10px;}
    .row > div {flex:1;}
    .hint {font-size:12px; color:#666; margin-top:6px;}
  </style>
</head>

  <body>

  <div class="topo">
    <img src="mark6-logo.jpg" alt="Mark6" class="logo">
  </div>

  <h1>Gerador de Jogos - Mega-Sena</h1>

  <div class="topo">
    <!-- 1) Troque o arquivo no repo para mark6-logo.jpg -->
    <img class="logo" src="mark6-logo.jpg" alt="Mark6">
  </div>

  <h1>Gerador de Jogos - Mega-Sena</h1>
  <p class="sub">Cadastro e liberação pelo administrador</p>

  <div id="login" class="card">
    <h2>Cadastro / Login</h2>

    <div style="margin:10px 0;">
      <input id="nome" placeholder="Nome" />
    </div>

    <div style="margin:10px 0;">
      <input id="email" placeholder="E-mail" />
    </div>

    <!-- NOVO: Telefone -->
    <div style="margin:10px 0;">
      <input id="telefone" placeholder="Telefone (com DDD)" inputmode="tel" />
      <div class="hint">Ex: (21) 99999-9999</div>
    </div>

    <div style="margin:10px 0;">
      <input id="senha" type="password" placeholder="Senha" />
    </div>

    <div>
      <button onclick="cadastrar()">Cadastrar</button>
      <button onclick="login()">Entrar</button>
    </div>
  </div>

  <div id="app" class="card" style="display:none;">
    <div class="row">
      <div>
        <button onclick="gerarJogoUsuario()">GERAR JOGO</button>
      </div>
      <div style="text-align:right;">
        <button onclick="sair()">Sair</button>
      </div>
    </div>

    <h2>Cartão Virtual</h2>
    <div id="cartao"></div>
    <p><strong>Acertos no último sorteio:</strong> <span id="acertos">0</span></p>

    <h3>Assinatura para liberar o gerador</h3>
    <button onclick="window.open('https://invoice.infinitepay.io/plans/silvia-regina-967/ito0zFDGX', '_blank')">
      Assinatura Mensal - R$ 29,90
    </button>
    <button onclick="window.open('https://invoice.infinitepay.io/plans/silvia-regina-967/1Cpgone7Tx', '_blank')">
      Assinatura Anual - R$ 238,80
    </button>
  </div>

  <script src="gerador.js"></script>

  <!-- Firebase + App (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // Firebase Config (o seu)
    const firebaseConfig = {
      apiKey: "AIzaSyA9ccyTSDoWiqrwnq9K7nAEjeOHZahKIu0",
      authDomain: "painel-megasena.firebaseapp.com",
      projectId: "painel-megasena",
      storageBucket: "painel-megasena.firebasestorage.app",
      messagingSenderId: "924943702876",
      appId: "1:924943702876:web:77929086c5addb13b37f99"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Disponibiliza pro resto do site (caso precise)
    window.db = db;

    let usuarioAtual = null;

    function normalizeEmail(email) {
      return (email || "").trim().toLowerCase();
    }

    // ID seguro pro documento (evita caracteres ruins)
    function userDocIdFromEmail(email) {
      return encodeURIComponent(normalizeEmail(email));
    }

    function onlyDigits(str) {
      return (str || "").replace(/\D/g, "");
    }

    function validarTelefone(telefone) {
      // validação simples: mínimo 10 dígitos (DDD + número)
      const d = onlyDigits(telefone);
      return d.length >= 10 && d.length <= 13;
    }

    // --------------------------
    // CADASTRAR (Firestore)
    // --------------------------
    window.cadastrar = async function cadastrar() {
      const nome  = document.getElementById('nome').value.trim();
      const email = normalizeEmail(document.getElementById('email').value);
      const telefone = document.getElementById('telefone').value.trim();
      const senha = document.getElementById('senha').value;

      if (!nome || !email || !telefone || !senha) return alert("Preencha todos os campos.");
      if (!email.includes("@")) return alert("E-mail inválido.");
      if (!validarTelefone(telefone)) return alert("Telefone inválido. Coloque com DDD.");

      const userId = userDocIdFromEmail(email);
      const ref = doc(db, "users", userId);

      // Impede duplicação: se já existe, bloqueia
      const snap = await getDoc(ref);
      if (snap.exists()) {
        return alert("E-mail já cadastrado. Faça login.");
      }

      await setDoc(ref, {
        nome,
        email,
        telefone,
        senha,
        accessGranted: false,
        createdAt: Date.now(),
        updatedAt: Date.now()
      });

      alert("Cadastrado com sucesso! Aguarde liberação do administrador.");
    };

    // --------------------------
    // LOGIN (Firestore)
    // --------------------------
    window.login = async function login() {
      const email = normalizeEmail(document.getElementById('email').value);
      const senha = document.getElementById('senha').value;

      if (!email || !senha) return alert("Digite e-mail e senha.");

      const userId = userDocIdFromEmail(email);
      const ref = doc(db, "users", userId);
      const snap = await getDoc(ref);

      if (!snap.exists()) return alert("Credenciais inválidas.");

      const user = snap.data();
      if (user.senha !== senha) return alert("Credenciais inválidas.");
      if (!user.accessGranted) return alert("Seu acesso ainda não foi liberado pelo administrador.");

      usuarioAtual = { id: userId, ...user };

      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display = 'block';

      renderCartao([]);
      document.getElementById('acertos').textContent = "0";
    };

    window.sair = function sair() {
      usuarioAtual = null;
      document.getElementById('app').style.display = 'none';
      document.getElementById('login').style.display = 'block';
      document.getElementById('senha').value = "";
    };

    // --------------------------
    // GERAR JOGO (Lê config/global do Firestore)
    // --------------------------
    window.gerarJogoUsuario = async function gerarJogoUsuario() {
      try {
        // lê config do admin no Firestore
        const cfgRef = doc(db, "config", "global");
        const cfgSnap = await getDoc(cfgRef);

        if (!cfgSnap.exists()) {
          alert("O administrador ainda não configurou o sistema (config/global).");
          return;
        }

        const cfg = cfgSnap.data();
        const linhasAtivas = Array.isArray(cfg.linhasAtivas) ? cfg.linhasAtivas : [];
        const anteriores = Array.isArray(cfg.dezenasAnteriores) ? cfg.dezenasAnteriores : [];
        const atrasadas  = Array.isArray(cfg.dezenasAtrasadas) ? cfg.dezenasAtrasadas : [];

        if (linhasAtivas.length === 0) {
          alert("O administrador ainda não configurou as linhas ativas.");
          return;
        }

        const excluidas = new Set([...(anteriores || []), ...(atrasadas || [])]);
        const jogo = gerarJogoValido(linhasAtivas, excluidas);

        renderCartao(jogo);

        const acertos = jogo.filter(n => (anteriores || []).includes(n)).length;
        document.getElementById('acertos').textContent = acertos;

      } catch (err) {
        alert("Erro ao gerar jogo: " + err.message);
      }
    };

    function renderCartao(jogo) {
      const cartao = document.getElementById('cartao');
      cartao.innerHTML = '';

      for (let l = 1; l <= 6; l++) {
        const div = document.createElement('div');
        div.className = 'linha';
        div.innerHTML = `<strong>Linha ${l} (${LINE_RANGES[l][0]}-${LINE_RANGES[l][9]}):</strong> `;

        LINE_RANGES[l].forEach(n => {
          const span = document.createElement('span');
          span.className = 'numero';
          span.textContent = String(n).padStart(2, '0');
          if (jogo.includes(n)) span.classList.add('selecionado');
          div.appendChild(span);
        });

        cartao.appendChild(div);
      }
    }
  </script>
</body>
</html>

